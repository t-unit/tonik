name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            sdk: stable
          - os: macos-latest
            sdk: stable
          - os: windows-latest
            sdk: stable
          - os: ubuntu-latest
            sdk: beta
      fail-fast: true

    steps:
      - uses: actions/checkout@v6

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ matrix.sdk }}

      - name: Cache Dart pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-dart-${{ matrix.sdk }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-dart-${{ matrix.sdk }}-
            ${{ runner.os }}-dart-

      - name: Cache Imposter JAR
        uses: actions/cache@v4
        with:
          path: integration_test/imposter.jar
          key: imposter-4.6.8
          restore-keys: imposter-

      - name: Install dependencies
        run: |
          dart pub global activate melos
          dart pub global activate coverage
          melos bootstrap

      - name: Setup integration test
        run: ./scripts/setup_integration_tests.sh
        shell: bash

      - name: Run tests with coverage
        run: melos run test:coverage 

      - name: Run all integration tests
        run: |
          cd integration_test
          
          # Run all integration tests in parallel
          # Each test suite uses unique ports, so no conflicts
          # Tests within a suite run sequentially (--concurrency=1)
          
          run_test() {
            local test_dir="$1"
            echo "Starting tests in $test_dir"
            (cd "$test_dir" && dart test --concurrency=1)
            local exit_code=$?
            if [ $exit_code -ne 0 ]; then
              echo "FAILED: $test_dir (exit code: $exit_code)"
              return $exit_code
            fi
            echo "PASSED: $test_dir"
            return 0
          }
          
          # Launch all test suites in parallel
          run_test petstore/petstore_test &
          run_test petstore_config/petstore_test &
          run_test music_streaming/music_streaming_test &
          run_test gov/gov_test &
          run_test simple_encoding/simple_encoding_test &
          run_test fastify_type_provider_zod/fastify_type_provider_zod_test &
          run_test composition/composition_test &
          run_test boolean_schemas/boolean_schemas_test &
          run_test binary_models/binary_models_test &
          run_test form_urlencoded/form_urlencoded_test &
          run_test path_encoding/path_encoding_test &
          run_test query_parameters/query_parameters_test &
          run_test type_arrays/type_arrays_test &
          run_test medama/medama_test &
          run_test inference/inference_test &
          run_test ref_siblings/ref_siblings_test &
          run_test defs/defs_test &
          run_test server_variables/server_variables_test &
          run_test cookies/cookies_test &
          
          # Wait for all background jobs and collect exit codes
          failed=0
          for job in $(jobs -p); do
            wait $job || failed=1
          done
          
          if [ $failed -ne 0 ]; then
            echo "One or more test suites failed"
            exit 1
          fi
          
          echo "All integration tests passed"

      - name: Format and merge coverage reports
        if: matrix.sdk == 'stable' && matrix.os == 'ubuntu-latest'
        run: |
          # Ensure output directory exists before format_coverage writes files
          mkdir -p coverage
          
          # Process each package separately to maintain correct source file paths (packages/*/lib)
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik/coverage \
            --out=coverage/tonik.lcov.info \
            --report-on=packages/tonik/lib \
            --check-ignore || true
          
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik_core/coverage \
            --out=coverage/tonik_core.lcov.info \
            --report-on=packages/tonik_core/lib \
            --check-ignore || true
          
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik_generate/coverage \
            --out=coverage/tonik_generate.lcov.info \
            --report-on=packages/tonik_generate/lib \
            --check-ignore || true
          
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik_parse/coverage \
            --out=coverage/tonik_parse.lcov.info \
            --report-on=packages/tonik_parse/lib \
            --check-ignore || true
          
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik_util/coverage \
            --out=coverage/tonik_util.lcov.info \
            --report-on=packages/tonik_util/lib \
            --check-ignore || true
          
          # Combine per-package reports into single file for codecov upload
          cat coverage/*.lcov.info > coverage/lcov.info 2>/dev/null || echo "No coverage files found"

      - name: Upload coverage to Codecov
        if: matrix.sdk == 'stable' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          disable_search: true
          token: ${{ secrets.CODECOV_TOKEN }}