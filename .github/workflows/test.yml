name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        sdk: [stable, beta]
      fail-fast: false

    steps:
      - uses: actions/checkout@v6

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ matrix.sdk }}

      - name: Install dependencies
        run: |
          dart pub global activate melos
          dart pub global activate coverage
          melos bootstrap

      - name: Setup integration test
        run: ./scripts/setup_integration_tests.sh
        shell: bash

      - name: Run tests with coverage
        run: melos run test:coverage 

      - name: Run petstore integration tests
        run: |
          cd integration_test/petstore/petstore_test
          dart pub get
          dart test --concurrency=1

      - name: Run petstore config integration tests
        run: |
          cd integration_test/petstore_config/petstore_test
          dart pub get
          dart test --concurrency=1

      - name: Run music streaming integration tests
        run: |
          cd integration_test/music_streaming/music_streaming_test
          dart pub get
          dart test --concurrency=1

      - name: Run gov integration tests
        run: |
          cd integration_test/gov/gov_test
          dart pub get
          dart test --concurrency=1

      - name: Run simple encoding integration tests
        run: |
          cd integration_test/simple_encoding/simple_encoding_test
          dart pub get
          dart test --concurrency=1

      - name: Run fastify type provider zod integration tests
        run: |
          cd integration_test/fastify_type_provider_zod/fastify_type_provider_zod_test
          dart pub get
          dart test --concurrency=1

      - name: Run composition integration tests
        run: |
          cd integration_test/composition/composition_test
          dart pub get
          dart test

      - name: Run boolean schemas integration tests
        run: |
          cd integration_test/boolean_schemas/boolean_schemas_test
          dart pub get
          dart test --concurrency=1

      - name: Run binary models integration tests
        run: |
          cd integration_test/binary_models/binary_models_test
          dart pub get
          dart test --concurrency=1

      - name: Run form urlencoded integration tests
        run: |
          cd integration_test/form_urlencoded/form_urlencoded_test
          dart pub get
          dart test --concurrency=1

      - name: Run path encoding integration tests
        run: |
          cd integration_test/path_encoding/path_encoding_test
          dart pub get
          dart test --concurrency=1

      - name: Run query parameters integration tests
        run: |
          cd integration_test/query_parameters/query_parameters_test
          dart pub get
          dart test --concurrency=1

      - name: Run type arrays integration tests
        run: |
          cd integration_test/type_arrays/type_arrays_test
          dart pub get
          dart test --concurrency=1

      - name: Run medama integration tests
        run: |
          cd integration_test/medama/medama_test
          dart pub get
          dart test --concurrency=1

      - name: Run inference integration tests
        run: |
          cd integration_test/inference/inference_test
          dart pub get
          dart test --concurrency=1

      - name: Run ref siblings integration tests
        run: |
          cd integration_test/ref_siblings/ref_siblings_test
          dart pub get
          dart test --concurrency=1

      - name: Run defs integration tests
        run: |
          cd integration_test/defs/defs_test
          dart pub get
          dart test --concurrency=1

      - name: Run server variables integration tests
        run: |
          cd integration_test/server_variables/server_variables_test
          dart pub get
          dart test --concurrency=1
      - name: Format and merge coverage reports
        if: matrix.sdk == 'stable' && matrix.os == 'ubuntu-latest'
        run: |
          # Ensure output directory exists before format_coverage writes files
          mkdir -p coverage
          
          # Process each package separately to maintain correct source file paths (packages/*/lib)
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik/coverage \
            --out=coverage/tonik.lcov.info \
            --report-on=packages/tonik/lib \
            --check-ignore || true
          
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik_core/coverage \
            --out=coverage/tonik_core.lcov.info \
            --report-on=packages/tonik_core/lib \
            --check-ignore || true
          
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik_generate/coverage \
            --out=coverage/tonik_generate.lcov.info \
            --report-on=packages/tonik_generate/lib \
            --check-ignore || true
          
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik_parse/coverage \
            --out=coverage/tonik_parse.lcov.info \
            --report-on=packages/tonik_parse/lib \
            --check-ignore || true
          
          dart pub global run coverage:format_coverage \
            --lcov \
            --in=packages/tonik_util/coverage \
            --out=coverage/tonik_util.lcov.info \
            --report-on=packages/tonik_util/lib \
            --check-ignore || true
          
          # Combine per-package reports into single file for codecov upload
          cat coverage/*.lcov.info > coverage/lcov.info 2>/dev/null || echo "No coverage files found"

      - name: Upload coverage to Codecov
        if: matrix.sdk == 'stable' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          disable_search: true
          token: ${{ secrets.CODECOV_TOKEN }}